<!DOCTYPE html>
<html lang="vi">
<head>
    <% include ../partials/head %>

    <!-- search box  -->
    <style>
    /*for search box in research page*/
    input[type=text] {
          width: 30%;
          padding: 10px 15px;
          margin: 8px 0;
          box-sizing: border-box;
          border: 3px solid #ccc;
          -webkit-transition: 0.5s;
          transition: 0.5s;
          outline: none;
    }

    input[type=text]:focus {
        border: 3px solid #555;
    }

    </style>
</head>
<body>

    <header>
        <% include ../partials/header %>
    </header>

    <main class="main-content">
        <div id="search_box">
            <input type="text" class="form-control input-sm" placeholder="Tìm kiếm lĩnh vực" id="search_field" name="searchText"/>
        </div>
        <div id="research_tree"></div>
    </main>

    <footer>
        <% include ../partials/footer %>
    </footer>

</body>
</html>

<!--CSS-->
<link rel="stylesheet" href="/dist/themes/default/style.css" />

<!--JS-->
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

<script>

    var maxID;

    $(document).ready(function(){
        // jstree
        $.jstree.defaults.core.themes.variant = "medium";
        $('#research_tree').jstree({
        'core' : {
            'data' : {
                'url' : 'research',
                'type': 'GET',
                'dataType' : 'json',
                'data' : (node) => {
                    return { 'id' : node.id };
                },
                success: (data) => {
                    maxID = data[0].id;
                    for (var i = 1; i < data.length; i++)
                    {
                        if (data[i].id > maxID)
                        {
                            maxID = data[i].id;
                        }
                    }
                    //console.log(maxID);
                }
            },
            'animation' : 150,
            "check_callback" : (operation, node, parent, position, more) => {
                if(operation === "delete_node" || operation === "copy_node" || operation === "move_node") {
                    if(parent.id === "#") {
                        return false; // prevent moving a child above or below the root
                    }
                }
                return true; // allow everything else
            }
        },
        'plugins' : ['state','contextmenu','search'],
        "search": {
            "case_insensitive": true,
            "show_only_matches": true
        },
        "contextmenu": {
            "items": ($node) => {
                var tree = $("#research_tree").jstree(true);
                return {
                    "create": {
                        "separator_before": false,
                        "separator_after": true,
                        "label": "Thêm lĩnh vực",
                        "action": (obj) => {
                            $node = tree.create_node($node);
                            tree.edit($node);
                        }
                    },
                    "rename": {
                        "separator_before": false,
                        "separator_after": false,
                        "label": "Đổi tên",
                        "action": (obj) => {
                            tree.edit($node);
                        }
                    },
                    "delete": {
                        "separator_before": false,
                        "separator_after": false,
                        "label": "Xóa",
                        "action": (obj) => {
                            if (confirm("Bạn chắc chắn muốn xóa mục này?")) {
                                tree.delete_node($node);
                            }
                        }
                    }
                };
            }
        }
        }).on('create_node.jstree', (e, data) => {
            console.log(data.node.parent + ", " + data.position + ", " + data.node.text);
            $.ajax({
                type:'POST',
                url:'research/create',
                dataType: 'json',
                data: {
                    id: maxID+1,
                    parent_id: data.node.parent,
                    text: data.node.text
                },
                success: (response) => {
                    console.log(response);
                    maxID++;
                    data.instance.set_id(data.node, maxID);
                }
            });

        }).on('rename_node.jstree', (e, data) => {
            $.ajax({
                type:'POST',
                url:'research/rename',
                dataType: 'json',
                data: {
                    id: data.node.id,
                    text: data.text
                },
                success: (response) => {
                    console.log(response);
                }
            });
        }).on('delete_node.jstree', (e, data) => {
            $.ajax({
                type:'POST',
                url:'research/delete',
                dataType: 'json',
                data: {
                    id: data.node.id
                },
                success: (response) => {
                    console.log(response);
                }
            });
        });


        $( "#search_field" ).keyup(function() {
           var text = $(this).val();
           search(text);
        });

        function search(text) {
            $('#research_tree').jstree(true).search(text);
        }

        /*function updateMaxID(){
            $.ajax({
                url: 'research',
                type: 'GET',
                dataType: 'json',
                success: (data) => {
                    maxID = data[0].id;
                    for (var i = 1; i < data.length; i++)
                    {
                        if (data[i].id > maxID)
                        {
                            maxID = data[i].id;
                        }
                    }
                    console.log(maxID);
                }
            })
        }*/
    });

</script>
